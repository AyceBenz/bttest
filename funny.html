<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serial File Transmission</title>
</head>
<body>
    <h1>Serial File Transmission</h1>

    <!-- Button to connect to serial port -->
    <button id="connectBtn">Connect to Serial Port</button>

    <!-- File input to upload hex file -->
    <input type="file" id="fileInput" accept=".h,.txt">
    
    <!-- Button to transmit data (disabled initially) -->
    <button id="transmitBtn" disabled>Transmit Data</button>

    <!-- Displaying status messages -->
    <p id="statusMessage"></p>

    <script>
        let port;
        let writer;

        // Function to connect to a serial port
        async function connectToSerial() {
            try {
                // Request user to select any available serial port
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });

                document.getElementById('transmitBtn').disabled = false;
                document.getElementById('statusMessage').innerText = 'Serial port connected.';
                
                const textEncoder = new TextEncoderStream();
                writer = textEncoder.writable.getWriter();
                const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);

                document.getElementById('transmitBtn').addEventListener('click', transmitData);

            } catch (error) {
                console.error("Error connecting to serial port: ", error);
            }
        }

        // Function to handle file reading, converting, and real-time transmission
        function processFile(file) {
            const reader = new FileReader();

            reader.onload = function(event) {
                let content = event.target.result;

                // Remove unwanted characters (commas, 0x, spaces, and line breaks)
                content = content.replace(/0x/g, '')        // Remove '0x'
                                 .replace(/,/g, '')        // Remove commas
                                 .replace(/\s+/g, '');     // Remove spaces and newlines
                
                // Split the content into chunks of 10 bytes (20 hex characters)
                let chunks = content.match(/.{1,20}/g);

                // Send each chunk in real-time (asynchronously)
                transmitChunks(chunks);
            };

            reader.readAsText(file);
        }

        // Function to transmit data chunks over serial in real-time
        async function transmitChunks(chunks) {
            for (const chunk of chunks) {
                if (writer) {
                    await writer.write(chunk);  // Transmit each chunk
                    console.log('Data transmitted:', chunk);

                    // Add a small delay between chunks to simulate real-time transmission
                    await new Promise(resolve => setTimeout(resolve, 100));  // 100ms delay
                }
            }

            console.log('Finished transmitting file.');
        }

        // Trigger file selection and process the file
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        });

        // Add event listener to connect button
        document.getElementById('connectBtn').addEventListener('click', connectToSerial);

        // Add event listener to transmit button
        function transmitData() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length > 0) {
                processFile(fileInput.files[0]);
            } else {
                alert('Please select a file first.');
            }
        }

    </script>
</body>
</html>
